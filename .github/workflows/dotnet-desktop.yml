name: Build APK Android (.NET + MonoGame)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: "Release ou Debug"
        required: false
        default: "Release"
      verbose:
        description: "Logs mais detalhados (true/false)"
        required: false
        default: "false"

concurrency:
  group: build-apk-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: "8.0.x"

  ANDROID_API: "34"
  ANDROID_API_EXTRA: "35"
  BUILD_TOOLS: "34.0.0"
  NDK_VERSION: "26.3.11579264"
  CMAKE_VERSION: "3.22.1"

  ANDROID_SDK_DIR: ${{ github.workspace }}/.android-sdk
  CMDLINE_TOOLS_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  NUGET_XMLDOC_MODE: skip
  DEBIAN_FRONTEND: noninteractive

  PROJECT_FILE: src/Celeste.Android/Celeste.Android.csproj
  CONFIGURATION_DEFAULT: Release

  CONTENT_ZIP_URL: ""
  CONTENT_DEST_DIR: src/Celeste.Android/Content

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/logs" "${GITHUB_WORKSPACE}/artifacts"
          mkdir -p "${ANDROID_SDK_DIR}"
          mkdir -p "${HOME}/.android"
          touch "${HOME}/.android/repositories.cfg"

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_DIR }}
          key: android-sdk-${{ runner.os }}-api${{ env.ANDROID_API }}-api${{ env.ANDROID_API_EXTRA }}-bt${{ env.BUILD_TOOLS }}-ndk${{ env.NDK_VERSION }}-cmake${{ env.CMAKE_VERSION }}-v7

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj','**/*.sln','**/global.json','NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: System packages (apt)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/apt.log"
          exec > >(tee -a "$LOG") 2>&1

          sudo apt-get update -y -qq
          sudo apt-get install -y -qq --no-install-recommends \
            git curl wget unzip zip tar xz-utils ca-certificates gnupg \
            build-essential cmake ninja-build pkg-config \
            clang llvm lld \
            python3 python3-pip \
            libsdl2-dev libopenal-dev libfreetype6-dev libfontconfig1-dev \
            libssl-dev zlib1g-dev \
            mono-complete

          mono --version | head -n 1 || true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup .NET SDK 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: .NET Android workload
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/dotnet-workload.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet --info
          dotnet workload list || true
          if ! dotnet workload list | grep -qi "android"; then
            dotnet workload install android
          fi

      - name: Android SDK (cmdline-tools + packages)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/android-sdk.log"
          exec > >(tee -a "$LOG") 2>&1

          SDK="${ANDROID_SDK_DIR}"
          mkdir -p "${SDK}/cmdline-tools" "${SDK}/platform-tools"

          if [ ! -d "${SDK}/cmdline-tools/latest" ]; then
            TMP_ZIP="/tmp/cmdline-tools.zip"
            TMP_DIR="/tmp/cmdline-extract"

            curl -fsSL "${CMDLINE_TOOLS_URL}" -o "${TMP_ZIP}"
            rm -rf "${TMP_DIR}"
            mkdir -p "${TMP_DIR}"
            unzip -q "${TMP_ZIP}" -d "${TMP_DIR}"

            mkdir -p "${SDK}/cmdline-tools/latest"

            if [ -d "${TMP_DIR}/cmdline-tools" ]; then
              cp -R "${TMP_DIR}/cmdline-tools/"* "${SDK}/cmdline-tools/latest/"
            elif [ -d "${TMP_DIR}/tools" ]; then
              cp -R "${TMP_DIR}/tools/"* "${SDK}/cmdline-tools/latest/"
            else
              cp -R "${TMP_DIR}/"* "${SDK}/cmdline-tools/latest/" || true
            fi

            rm -rf "${TMP_DIR}" "${TMP_ZIP}"
          fi

          export ANDROID_HOME="${SDK}"
          export ANDROID_SDK_ROOT="${SDK}"
          export PATH="${SDK}/cmdline-tools/latest/bin:${SDK}/platform-tools:${PATH}"

          SDKMANAGER="${SDK}/cmdline-tools/latest/bin/sdkmanager"
          [ -x "$SDKMANAGER" ] || chmod +x "$SDKMANAGER" || true
          [ -x "$SDKMANAGER" ] || (ls -la "${SDK}/cmdline-tools/latest/bin" && exit 1)

          "$SDKMANAGER" --version

          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null
          lic_rc="${PIPESTATUS[1]}"
          set -o pipefail
          [ "$lic_rc" -eq 0 ] || (echo "Falha licenças rc=$lic_rc" && exit "$lic_rc")

          set +o pipefail
          yes | "$SDKMANAGER" --install \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "platforms;android-${ANDROID_API_EXTRA}" \
            "build-tools;${BUILD_TOOLS}" \
            "ndk;${NDK_VERSION}" \
            "cmake;${CMAKE_VERSION}" >/dev/null
          inst_rc="${PIPESTATUS[1]}"
          set -o pipefail
          [ "$inst_rc" -eq 0 ] || (echo "Falha install SDK rc=$inst_rc" && exit "$inst_rc")

          ls -la "${SDK}/platforms" || true
          adb version || true

          echo "${SDK}/cmdline-tools/latest/bin" >> "${GITHUB_PATH}"
          echo "${SDK}/platform-tools" >> "${GITHUB_PATH}"
          echo "ANDROID_HOME=${SDK}" >> "${GITHUB_ENV}"
          echo "ANDROID_SDK_ROOT=${SDK}" >> "${GITHUB_ENV}"

      - name: Restore (NuGet)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/restore.log"
          exec > >(tee -a "$LOG") 2>&1

          test -f "${PROJECT_FILE}" || (echo "PROJECT_FILE não existe: ${PROJECT_FILE}" && ls -la && exit 1)
          dotnet restore "${PROJECT_FILE}"

      - name: Install Android dependencies (target do .NET) [opcional/robusto]
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/install-android-deps.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet build "${PROJECT_FILE}" -t:InstallAndroidDependencies -p:AndroidSdkDirectory="${ANDROID_SDK_DIR}" || true

      - name: Content.zip (opcional)
        if: ${{ env.CONTENT_ZIP_URL != '' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/content.log"
          exec > >(tee -a "$LOG") 2>&1

          mkdir -p "${CONTENT_DEST_DIR}"
          curl -fL "${CONTENT_ZIP_URL}" -o /tmp/Content.zip
          unzip -q /tmp/Content.zip -d "${CONTENT_DEST_DIR}"
          rm -f /tmp/Content.zip
          du -sh "${CONTENT_DEST_DIR}" || true

      - name: Build + Publish APK
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/build.log"
          exec > >(tee -a "$LOG") 2>&1

          CONFIG="${{ inputs.configuration }}"
          if [ -z "${CONFIG}" ]; then
            CONFIG="${CONFIGURATION_DEFAULT}"
          fi

          VERBOSE="${{ inputs.verbose }}"
          VFLAG="minimal"
          if [ "${VERBOSE}" = "true" ]; then
            VFLAG="diag"
          fi

          echo "CONFIG=${CONFIG}"
          dotnet build "${PROJECT_FILE}" -c "${CONFIG}" -v "${VFLAG}"
          dotnet publish "${PROJECT_FILE}" -c "${CONFIG}" -v "${VFLAG}" -o "${GITHUB_WORKSPACE}/publish"

      - name: Collect APK/AAB + hashes
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/collect.log"
          exec > >(tee -a "$LOG") 2>&1

          mkdir -p "${GITHUB_WORKSPACE}/artifacts"

          mapfile -t BUNDLES < <(find "${GITHUB_WORKSPACE}" -type f \( -name "*.apk" -o -name "*.aab" \) | sort || true)
          if [ "${#BUNDLES[@]}" -eq 0 ]; then
            echo "Nenhum APK/AAB encontrado."
            echo "Listando pasta publish:"
            find "${GITHUB_WORKSPACE}/publish" -maxdepth 6 -type f | head -n 200 || true
            exit 1
          fi

          for b in "${BUNDLES[@]}"; do
            cp -f "$b" "${GITHUB_WORKSPACE}/artifacts/$(basename "$b")"
          done

          (cd "${GITHUB_WORKSPACE}/artifacts" && sha256sum * > SHA256SUMS.txt)
          ls -la "${GITHUB_WORKSPACE}/artifacts"

      - name: Step Summary
        shell: bash
        run: |
          set -Eeuo pipefail
          OS_NAME="$(grep PRETTY_NAME /etc/os-release | cut -d= -f2- | tr -d '"')"
          KERNEL="$(uname -r)"
          JAVA_LINE="$(java -version 2>&1 | head -n 1 || true)"
          DOTNET_V="$(dotnet --version 2>/dev/null || echo 'n/a')"
          MONO_V="$(mono --version 2>/dev/null | head -n 1 || echo 'n/a')"
          ADB_V="$(adb version 2>/dev/null | head -n 1 || echo 'n/a')"
          APK_COUNT="$(ls -1 artifacts/*.apk 2>/dev/null | wc -l | tr -d ' ')"
          AAB_COUNT="$(ls -1 artifacts/*.aab 2>/dev/null | wc -l | tr -d ' ')"

          {
            echo "## Build APK Android"
            echo ""
            echo "| Item | Valor |"
            echo "|---|---|"
            echo "| Data (UTC) | $(date -u) |"
            echo "| OS | ${OS_NAME} |"
            echo "| Kernel | ${KERNEL} |"
            echo "| Java | ${JAVA_LINE} |"
            echo "| .NET SDK | ${DOTNET_V} |"
            echo "| Mono | ${MONO_V} |"
            echo "| Android API instalada | ${ANDROID_API} + ${ANDROID_API_EXTRA} |"
            echo "| Build-Tools | ${BUILD_TOOLS} |"
            echo "| NDK | ${NDK_VERSION} |"
            echo "| CMake | ${CMAKE_VERSION} |"
            echo "| ANDROID_SDK_ROOT | ${ANDROID_SDK_ROOT:-unset} |"
            echo "| ADB | ${ADB_V} |"
            echo "| Projeto | ${PROJECT_FILE} |"
            echo "| APKs | ${APK_COUNT} |"
            echo "| AABs | ${AAB_COUNT} |"
            echo ""
            echo "### SHA256"
            echo "\`\`\`"
            cat artifacts/SHA256SUMS.txt 2>/dev/null || true
            echo "\`\`\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: artifacts/
          if-no-files-found: error

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/
          if-no-files-found: warn
