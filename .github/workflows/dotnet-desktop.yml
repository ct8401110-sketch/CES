name: Bootstrap Android + .NET + MonoGame (Final)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: bootstrap-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  ANDROID_API: "34"
  BUILD_TOOLS: "34.0.0"
  NDK_VERSION: "26.3.11579264"
  CMAKE_VERSION: "3.22.1"
  DOTNET_VERSION: "8.0.x"
  NODE_VERSION: "20"
  ANDROID_SDK_DIR: ${{ github.workspace }}/.android-sdk
  CMDLINE_TOOLS_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

  DEBIAN_FRONTEND: noninteractive
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  NUGET_XMLDOC_MODE: skip

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init logs + dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/logs"
          mkdir -p "${ANDROID_SDK_DIR}"
          mkdir -p "${HOME}/.android"
          touch "${HOME}/.android/repositories.cfg"

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_DIR }}
          key: android-sdk-${{ runner.os }}-api${{ env.ANDROID_API }}-bt${{ env.BUILD_TOOLS }}-ndk${{ env.NDK_VERSION }}-cmake${{ env.CMAKE_VERSION }}-v5

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj','**/*.sln','**/global.json','NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Cache dotnet tools
        uses: actions/cache@v4
        with:
          path: ~/.dotnet/tools
          key: dotnet-tools-${{ runner.os }}-${{ hashFiles('**/*.config/dotnet-tools.json') }}
          restore-keys: |
            dotnet-tools-${{ runner.os }}-

      - name: System packages (apt)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/apt-install.log"
          exec > >(tee -a "$LOG") 2>&1

          sudo apt-get update -y -qq

          sudo apt-get install -y -qq --no-install-recommends \
            bash coreutils git curl wget unzip zip tar xz-utils software-properties-common \
            build-essential gcc g++ make cmake ninja-build pkg-config autoconf libtool \
            clang llvm lld gdb python3 python3-pip \
            libsdl2-dev libopenal-dev libfreetype6-dev libfontconfig1-dev \
            libssl-dev zlib1g-dev \
            ca-certificates gnupg apt-transport-https

      - name: Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Detect Node lockfile
        id: node_lock
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ] || [ -f yarn.lock ]; then
            echo "has_lock=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_lock=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js 20 (cache se tiver lockfile)
        if: steps.node_lock.outputs.has_lock == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Setup Node.js 20 (sem cache)
        if: steps.node_lock.outputs.has_lock != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup .NET SDK 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: .NET Android Workload
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/dotnet-workload-android.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet --info
          dotnet workload list || true

          if ! dotnet workload list | grep -qi "android"; then
            dotnet workload install android
          fi

          dotnet workload list | sed -n '1,220p' || true

      - name: Android SDK (cmdline-tools + packages)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/android-sdk.log"
          exec > >(tee -a "$LOG") 2>&1

          SDK="${ANDROID_SDK_DIR}"
          mkdir -p "${SDK}/cmdline-tools" "${SDK}/platform-tools"
          mkdir -p "${HOME}/.android"
          touch "${HOME}/.android/repositories.cfg"

          if [ ! -d "${SDK}/cmdline-tools/latest" ]; then
            TMP_ZIP="/tmp/cmdline-tools.zip"
            TMP_DIR="/tmp/cmdline-extract"

            curl -fsSL "${CMDLINE_TOOLS_URL}" -o "${TMP_ZIP}"
            rm -rf "${TMP_DIR}"
            mkdir -p "${TMP_DIR}"
            unzip -q "${TMP_ZIP}" -d "${TMP_DIR}"

            mkdir -p "${SDK}/cmdline-tools/latest"

            if [ -d "${TMP_DIR}/cmdline-tools" ]; then
              cp -R "${TMP_DIR}/cmdline-tools/"* "${SDK}/cmdline-tools/latest/"
            elif [ -d "${TMP_DIR}/tools" ]; then
              cp -R "${TMP_DIR}/tools/"* "${SDK}/cmdline-tools/latest/"
            else
              cp -R "${TMP_DIR}/"* "${SDK}/cmdline-tools/latest/" || true
            fi

            rm -rf "${TMP_DIR}" "${TMP_ZIP}"
          fi

          export ANDROID_HOME="${SDK}"
          export ANDROID_SDK_ROOT="${SDK}"
          export PATH="${SDK}/cmdline-tools/latest/bin:${SDK}/platform-tools:${PATH}"

          SDKMANAGER="${SDK}/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -x "$SDKMANAGER" ]; then
            chmod +x "$SDKMANAGER" || true
          fi

          if [ ! -x "$SDKMANAGER" ]; then
            echo "sdkmanager não encontrado/exec em: $SDKMANAGER"
            ls -la "${SDK}/cmdline-tools/latest" || true
            ls -la "${SDK}/cmdline-tools/latest/bin" || true
            exit 1
          fi

          "$SDKMANAGER" --version

          # Com pipefail ativo, "yes" costuma dar Broken pipe (exit 141) quando o sdkmanager fecha.
          # Aqui a gente desliga pipefail só nesse trecho e valida o exit code REAL do sdkmanager.
          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null
          lic_rc="${PIPESTATUS[1]}"
          set -o pipefail
          if [ "$lic_rc" -ne 0 ]; then
            echo "Falha aceitando licenças. rc=${lic_rc}"
            exit "$lic_rc"
          fi

          set +o pipefail
          yes | "$SDKMANAGER" --install \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "build-tools;${BUILD_TOOLS}" \
            "ndk;${NDK_VERSION}" \
            "cmake;${CMAKE_VERSION}" >/dev/null
          inst_rc="${PIPESTATUS[1]}"
          set -o pipefail
          if [ "$inst_rc" -ne 0 ]; then
            echo "Falha instalando pacotes Android SDK. rc=${inst_rc}"
            exit "$inst_rc"
          fi

          adb version || true

          echo "${SDK}/cmdline-tools/latest/bin" >> "${GITHUB_PATH}"
          echo "${SDK}/platform-tools" >> "${GITHUB_PATH}"
          echo "ANDROID_HOME=${SDK}" >> "${GITHUB_ENV}"
          echo "ANDROID_SDK_ROOT=${SDK}" >> "${GITHUB_ENV}"

      - name: Mono (mono-complete)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/mono.log"
          exec > >(tee -a "$LOG") 2>&1

          sudo apt-get update -y -qq
          sudo apt-get install -y -qq --no-install-recommends mono-complete
          mono --version | head -n 1 || true

      - name: MonoGame templates + MGCB editor
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/monogame-mgcb.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet new install MonoGame.Templates.CSharp || true
          dotnet tool install --global dotnet-mgcb-editor || true

          echo "${HOME}/.dotnet/tools" >> "${GITHUB_PATH}"
          dotnet-mgcb-editor --help >/dev/null 2>&1 || true

      - name: Smoke checks
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/smoke-checks.log"
          exec > >(tee -a "$LOG") 2>&1

          echo "JAVA_HOME=${JAVA_HOME:-unset}"
          java -version 2>&1 | head -n 2 || true

          echo "NODE=$(node -v 2>/dev/null || echo n/a)"
          echo "NPM=$(npm -v 2>/dev/null || echo n/a)"

          echo "DOTNET=$(dotnet --version 2>/dev/null || echo n/a)"
          dotnet --list-sdks || true
          dotnet workload list || true

          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-unset}"
          command -v sdkmanager || true
          command -v adb || true
          adb version || true

      - name: Build summary
        shell: bash
        run: |
          set -Eeuo pipefail

          OS_NAME="$(grep PRETTY_NAME /etc/os-release | cut -d= -f2- | tr -d '"')"
          KERNEL="$(uname -r)"
          JAVA_LINE="$(java -version 2>&1 | head -n 1 || true)"
          NODE_V="$(node -v 2>/dev/null || echo 'n/a')"
          NPM_V="$(npm -v 2>/dev/null || echo 'n/a')"
          DOTNET_V="$(dotnet --version 2>/dev/null || echo 'n/a')"
          MONO_V="$(mono --version 2>/dev/null | head -n 1 || echo 'n/a')"
          ADB_V="$("${ANDROID_SDK_ROOT:-/dev/null}/platform-tools/adb" version 2>/dev/null | head -n 1 || echo 'n/a')"

          {
            echo "## Summary do Bootstrap"
            echo ""
            echo "| Item | Valor |"
            echo "|---|---|"
            echo "| Data (UTC) | $(date -u) |"
            echo "| OS | ${OS_NAME} |"
            echo "| Kernel | ${KERNEL} |"
            echo "| Java | ${JAVA_LINE} |"
            echo "| Node | ${NODE_V} |"
            echo "| NPM | ${NPM_V} |"
            echo "| .NET SDK | ${DOTNET_V} |"
            echo "| Mono | ${MONO_V} |"
            echo "| Android API | ${ANDROID_API} |"
            echo "| Build-Tools | ${BUILD_TOOLS} |"
            echo "| NDK | ${NDK_VERSION} |"
            echo "| CMake | ${CMAKE_VERSION} |"
            echo "| ANDROID_SDK_ROOT | ${ANDROID_SDK_ROOT:-unset} |"
            echo "| ADB | ${ADB_V} |"
            echo ""
            echo "Logs: artifact bootstrap-logs (pasta logs/)"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-logs
          path: logs/
          if-no-files-found: warn
