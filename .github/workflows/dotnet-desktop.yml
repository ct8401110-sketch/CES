name: ðŸŽ® Build Celeste Android (MonoGame + .NET) â€” Final Extenso

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: "Release ou Debug"
        required: false
        default: "Release"
      verbose:
        description: "Logs mais detalhados (true/false)"
        required: false
        default: "false"
      package_format:
        description: "apk ou aab (se vazio, usa o csproj)"
        required: false
        default: ""
      rid:
        description: "RuntimeIdentifier(s). Ex: android-arm64 ou android-arm64;android-x64"
        required: false
        default: "android-arm64"
      content_zip_url:
        description: "URL opcional do Content.zip (se vazio, nÃ£o baixa)"
        required: false
        default: ""

concurrency:
  group: celeste-android-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  # IMPORTANTE:
  # Seu csproj estÃ¡ em net9.0-android, entÃ£o o runner precisa do .NET 9.
  DOTNET_VERSION: "9.0.x"

  # Android SDK/NDK/CMake
  ANDROID_API: "34"
  ANDROID_API_EXTRA: "35"
  BUILD_TOOLS: "34.0.0"
  NDK_VERSION: "26.3.11579264"
  CMAKE_VERSION: "3.22.1"

  ANDROID_SDK_DIR: ${{ github.workspace }}/.android-sdk
  CMDLINE_TOOLS_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

  # Qualidade e telemetria
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  NUGET_XMLDOC_MODE: skip
  DEBIAN_FRONTEND: noninteractive

  # Projeto
  PROJECT_FILE: src/Celeste.Android/Celeste.Android.csproj
  CONFIGURATION_DEFAULT: Release

  # Content (padrÃ£o: nÃ£o baixa)
  CONTENT_DEST_DIR: src/Celeste.Android/Content

jobs:
  build:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 150

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init workspace (logs/artifacts)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/logs" "${GITHUB_WORKSPACE}/artifacts" "${GITHUB_WORKSPACE}/publish"
          mkdir -p "${ANDROID_SDK_DIR}"
          mkdir -p "${HOME}/.android"
          touch "${HOME}/.android/repositories.cfg"
          echo "WORKSPACE=${GITHUB_WORKSPACE}"
          echo "PROJECT_FILE=${PROJECT_FILE}"
          ls -la

      - name: Validate project path
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/validate-project.log"
          exec > >(tee -a "$LOG") 2>&1

          if [ ! -f "${PROJECT_FILE}" ]; then
            echo "ERRO: PROJECT_FILE nÃ£o existe: ${PROJECT_FILE}"
            echo "Listando src/:"
            ls -la src || true
            echo "Buscando csproj:"
            find . -maxdepth 4 -name "*.csproj" -print || true
            exit 1
          fi

          echo "OK: csproj encontrado."
          sed -n '1,80p' "${PROJECT_FILE}" || true

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_DIR }}
          key: android-sdk-${{ runner.os }}-api${{ env.ANDROID_API }}-api${{ env.ANDROID_API_EXTRA }}-bt${{ env.BUILD_TOOLS }}-ndk${{ env.NDK_VERSION }}-cmake${{ env.CMAKE_VERSION }}-v9

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj','**/*.sln','**/global.json','NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Cache dotnet tools
        uses: actions/cache@v4
        with:
          path: ~/.dotnet/tools
          key: dotnet-tools-${{ runner.os }}-${{ hashFiles('**/*.config/dotnet-tools.json') }}
          restore-keys: |
            dotnet-tools-${{ runner.os }}-

      - name: System packages (apt) + Mono
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/apt.log"
          exec > >(tee -a "$LOG") 2>&1

          sudo apt-get update -y -qq
          sudo apt-get install -y -qq --no-install-recommends \
            git curl wget unzip zip tar xz-utils ca-certificates gnupg \
            build-essential cmake ninja-build pkg-config \
            clang llvm lld \
            python3 python3-pip \
            libsdl2-dev libopenal-dev libfreetype6-dev libfontconfig1-dev \
            libssl-dev zlib1g-dev \
            mono-complete

          echo "Mono:"
          mono --version | head -n 2 || true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Print toolchain versions
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/versions.log"
          exec > >(tee -a "$LOG") 2>&1

          echo "OS:"
          cat /etc/os-release | sed -n '1,20p' || true
          echo ""
          echo "Kernel: $(uname -r)"
          echo ""
          echo "Java:"
          java -version 2>&1 | head -n 3 || true
          echo ""
          echo "dotnet:"
          dotnet --info || true
          echo ""
          echo "mono:"
          mono --version | head -n 2 || true

      - name: Install .NET Android workload
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/dotnet-workload.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet workload list || true
          if ! dotnet workload list | grep -qi "android"; then
            dotnet workload install android
          fi
          dotnet workload list | sed -n '1,260p' || true

      - name: Android SDK (cmdline-tools + platforms/build-tools/ndk/cmake)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/android-sdk.log"
          exec > >(tee -a "$LOG") 2>&1

          SDK="${ANDROID_SDK_DIR}"
          mkdir -p "${SDK}/cmdline-tools" "${SDK}/platform-tools"
          mkdir -p "${HOME}/.android"
          touch "${HOME}/.android/repositories.cfg"

          if [ ! -d "${SDK}/cmdline-tools/latest" ]; then
            TMP_ZIP="/tmp/cmdline-tools.zip"
            TMP_DIR="/tmp/cmdline-extract"

            echo "Baixando cmdline-tools..."
            curl -fsSL "${CMDLINE_TOOLS_URL}" -o "${TMP_ZIP}"

            rm -rf "${TMP_DIR}"
            mkdir -p "${TMP_DIR}"
            unzip -q "${TMP_ZIP}" -d "${TMP_DIR}"

            mkdir -p "${SDK}/cmdline-tools/latest"

            if [ -d "${TMP_DIR}/cmdline-tools" ]; then
              cp -R "${TMP_DIR}/cmdline-tools/"* "${SDK}/cmdline-tools/latest/"
            elif [ -d "${TMP_DIR}/tools" ]; then
              cp -R "${TMP_DIR}/tools/"* "${SDK}/cmdline-tools/latest/"
            else
              cp -R "${TMP_DIR}/"* "${SDK}/cmdline-tools/latest/" || true
            fi

            rm -rf "${TMP_DIR}" "${TMP_ZIP}"
          fi

          export ANDROID_HOME="${SDK}"
          export ANDROID_SDK_ROOT="${SDK}"
          export PATH="${SDK}/cmdline-tools/latest/bin:${SDK}/platform-tools:${PATH}"

          SDKMANAGER="${SDK}/cmdline-tools/latest/bin/sdkmanager"
          [ -x "$SDKMANAGER" ] || chmod +x "$SDKMANAGER" || true
          [ -x "$SDKMANAGER" ] || (echo "sdkmanager nÃ£o executÃ¡vel" && ls -la "${SDK}/cmdline-tools/latest/bin" && exit 1)

          echo "sdkmanager version:"
          "$SDKMANAGER" --version

          echo "Aceitando licenÃ§as (ignorando broken pipe do yes)..."
          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null
          lic_rc="${PIPESTATUS[1]}"
          set -o pipefail
          if [ "$lic_rc" -ne 0 ]; then
            echo "Falha licenÃ§as rc=$lic_rc"
            exit "$lic_rc"
          fi

          echo "Instalando pacotes Android..."
          set +o pipefail
          yes | "$SDKMANAGER" --install \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "platforms;android-${ANDROID_API_EXTRA}" \
            "build-tools;${BUILD_TOOLS}" \
            "ndk;${NDK_VERSION}" \
            "cmake;${CMAKE_VERSION}" >/dev/null
          inst_rc="${PIPESTATUS[1]}"
          set -o pipefail
          if [ "$inst_rc" -ne 0 ]; then
            echo "Falha install SDK rc=$inst_rc"
            exit "$inst_rc"
          fi

          echo "Verificando android.jar:"
          ls -la "${SDK}/platforms/android-${ANDROID_API}/android.jar" || true
          ls -la "${SDK}/platforms/android-${ANDROID_API_EXTRA}/android.jar" || true

          echo "Persistindo PATH/ENV para os prÃ³ximos steps..."
          echo "${SDK}/cmdline-tools/latest/bin" >> "${GITHUB_PATH}"
          echo "${SDK}/platform-tools" >> "${GITHUB_PATH}"
          echo "ANDROID_HOME=${SDK}" >> "${GITHUB_ENV}"
          echo "ANDROID_SDK_ROOT=${SDK}" >> "${GITHUB_ENV}"

          echo "ADB:"
          adb version || true

      - name: Optional Content.zip download (workflow_dispatch)
        if: ${{ inputs.content_zip_url != '' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/content.log"
          exec > >(tee -a "$LOG") 2>&1

          echo "Baixando Content.zip..."
          mkdir -p "${CONTENT_DEST_DIR}"
          curl -fL "${{ inputs.content_zip_url }}" -o /tmp/Content.zip
          unzip -q /tmp/Content.zip -d "${CONTENT_DEST_DIR}"
          rm -f /tmp/Content.zip

          echo "Tamanho do Content:"
          du -sh "${CONTENT_DEST_DIR}" || true
          echo "Top 40 maiores arquivos:"
          (cd "${CONTENT_DEST_DIR}" && find . -type f -printf "%s %p\n" | sort -nr | head -n 40) || true

      - name: Restore (NuGet) â€” com SDK dir e licenÃ§as
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/restore.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet restore "${PROJECT_FILE}" \
            -p:AndroidSdkDirectory="${ANDROID_SDK_DIR}" \
            -p:AcceptAndroidSDKLicenses=true

      - name: Compute build parameters (CONFIG/VERBOSE/RID/PACKAGE_FORMAT)
        id: params
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/params.log"
          exec > >(tee -a "$LOG") 2>&1

          CONFIG="${{ inputs.configuration }}"
          if [ -z "${CONFIG}" ]; then
            CONFIG="${CONFIGURATION_DEFAULT}"
          fi

          VERBOSE="${{ inputs.verbose }}"
          VFLAG="minimal"
          if [ "${VERBOSE}" = "true" ]; then
            VFLAG="diag"
          fi

          RID="${{ inputs.rid }}"
          if [ -z "${RID}" ]; then
            RID="android-arm64"
          fi

          PKG="${{ inputs.package_format }}"
          if [ -z "${PKG}" ]; then
            PKG=""
          fi

          echo "CONFIG=${CONFIG}" >> "$GITHUB_OUTPUT"
          echo "VFLAG=${VFLAG}" >> "$GITHUB_OUTPUT"
          echo "RID=${RID}" >> "$GITHUB_OUTPUT"
          echo "PKG=${PKG}" >> "$GITHUB_OUTPUT"

          echo "CONFIG=${CONFIG}"
          echo "VFLAG=${VFLAG}"
          echo "RID=${RID}"
          echo "PKG=${PKG:-<usa csproj>}"

      - name: Dump csproj Android-related props (rÃ¡pido)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/csproj-scan.log"
          exec > >(tee -a "$LOG") 2>&1

          echo "Procurando propriedades importantes no csproj:"
          grep -nE "TargetFramework|Android(TargetSdkVersion|MinSdkVersion|PackageFormat|SupportedAbis)|RuntimeIdentifiers|AcceptAndroidSDKLicenses" -n "${PROJECT_FILE}" || true

      - name: Build (Android)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/build.log"
          exec > >(tee -a "$LOG") 2>&1

          CONFIG="${{ steps.params.outputs.CONFIG }}"
          VFLAG="${{ steps.params.outputs.VFLAG }}"
          RID="${{ steps.params.outputs.RID }}"
          PKG="${{ steps.params.outputs.PKG }}"

          EXTRA_PROPS=()
          EXTRA_PROPS+=("-p:AndroidSdkDirectory=${ANDROID_SDK_DIR}")
          EXTRA_PROPS+=("-p:AcceptAndroidSDKLicenses=true")

          # ForÃ§a RID para matar warning de AndroidSupportedAbis e garantir arm64
          EXTRA_PROPS+=("-p:RuntimeIdentifiers=${RID}")

          # Se o usuÃ¡rio setar package_format, sobrescreve o csproj
          if [ -n "${PKG}" ]; then
            EXTRA_PROPS+=("-p:AndroidPackageFormat=${PKG}")
          fi

          echo "dotnet build ${PROJECT_FILE} -c ${CONFIG} -v ${VFLAG} ${EXTRA_PROPS[*]}"
          dotnet build "${PROJECT_FILE}" -c "${CONFIG}" -v "${VFLAG}" "${EXTRA_PROPS[@]}"

      - name: Publish (Android)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/publish.log"
          exec > >(tee -a "$LOG") 2>&1

          CONFIG="${{ steps.params.outputs.CONFIG }}"
          VFLAG="${{ steps.params.outputs.VFLAG }}"
          RID="${{ steps.params.outputs.RID }}"
          PKG="${{ steps.params.outputs.PKG }}"

          EXTRA_PROPS=()
          EXTRA_PROPS+=("-p:AndroidSdkDirectory=${ANDROID_SDK_DIR}")
          EXTRA_PROPS+=("-p:AcceptAndroidSDKLicenses=true")
          EXTRA_PROPS+=("-p:RuntimeIdentifiers=${RID}")

          if [ -n "${PKG}" ]; then
            EXTRA_PROPS+=("-p:AndroidPackageFormat=${PKG}")
          fi

          rm -rf "${GITHUB_WORKSPACE}/publish"
          mkdir -p "${GITHUB_WORKSPACE}/publish"

          echo "dotnet publish ${PROJECT_FILE} -c ${CONFIG} -v ${VFLAG} -o publish ${EXTRA_PROPS[*]}"
          dotnet publish "${PROJECT_FILE}" -c "${CONFIG}" -v "${VFLAG}" \
            -o "${GITHUB_WORKSPACE}/publish" \
            "${EXTRA_PROPS[@]}"

          echo "Listando publish (top 200):"
          find "${GITHUB_WORKSPACE}/publish" -type f | head -n 200 || true

      - name: Locate outputs (apk/aab) + copy to artifacts
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/collect.log"
          exec > >(tee -a "$LOG") 2>&1

          mkdir -p "${GITHUB_WORKSPACE}/artifacts"

          echo "Buscando APK/AAB no workspace..."
          mapfile -t BUNDLES < <(find "${GITHUB_WORKSPACE}" -type f \( -name "*.apk" -o -name "*.aab" \) | sort || true)

          if [ "${#BUNDLES[@]}" -eq 0 ]; then
            echo "Nenhum APK/AAB encontrado."
            echo "Dump publish (top 300):"
            find "${GITHUB_WORKSPACE}/publish" -type f | head -n 300 || true
            echo "Dump src/Celeste.Android (bin/obj) (top 300):"
            find "${GITHUB_WORKSPACE}/src/Celeste.Android" -type f | head -n 300 || true
            exit 1
          fi

          echo "Encontrados:"
          printf '%s\n' "${BUNDLES[@]}"

          for b in "${BUNDLES[@]}"; do
            base="$(basename "$b")"
            cp -f "$b" "${GITHUB_WORKSPACE}/artifacts/${base}"
          done

          echo "Hashes:"
          (cd "${GITHUB_WORKSPACE}/artifacts" && sha256sum * > SHA256SUMS.txt)

          ls -la "${GITHUB_WORKSPACE}/artifacts"
          du -sh "${GITHUB_WORKSPACE}/artifacts" || true

      - name: Extra diagnostics (se falhar, Ãºtil pra debug)
        if: ${{ failure() }}
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/diagnostics.log"
          exec > >(tee -a "$LOG") 2>&1

          echo "=== ENV ==="
          env | sort | sed -n '1,220p' || true

          echo "=== DOTNET SDKs ==="
          dotnet --list-sdks || true

          echo "=== DOTNET Workloads ==="
          dotnet workload list || true

          echo "=== ANDROID SDK DIR ==="
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-unset}"
          echo "ANDROID_HOME=${ANDROID_HOME:-unset}"
          ls -la "${ANDROID_SDK_DIR}" || true
          ls -la "${ANDROID_SDK_DIR}/platforms" || true
          ls -la "${ANDROID_SDK_DIR}/build-tools" || true

          echo "=== PROJECT TREE (android) ==="
          ls -la src/Celeste.Android || true
          find src/Celeste.Android -maxdepth 4 -type f -name "*.cs" -o -name "*.csproj" -o -name "*.xml" | head -n 200 || true

      - name: Step Summary (GITHUB_STEP_SUMMARY)
        shell: bash
        run: |
          set -Eeuo pipefail

          OS_NAME="$(grep PRETTY_NAME /etc/os-release | cut -d= -f2- | tr -d '"')"
          KERNEL="$(uname -r)"
          JAVA_LINE="$(java -version 2>&1 | head -n 1 || true)"
          DOTNET_V="$(dotnet --version 2>/dev/null || echo 'n/a')"
          MONO_V="$(mono --version 2>/dev/null | head -n 1 || echo 'n/a')"
          ADB_V="$(adb version 2>/dev/null | head -n 1 || echo 'n/a')"

          APK_COUNT="$(ls -1 artifacts/*.apk 2>/dev/null | wc -l | tr -d ' ')"
          AAB_COUNT="$(ls -1 artifacts/*.aab 2>/dev/null | wc -l | tr -d ' ')"

          CONFIG="${{ steps.params.outputs.CONFIG }}"
          VFLAG="${{ steps.params.outputs.VFLAG }}"
          RID="${{ steps.params.outputs.RID }}"
          PKG="${{ steps.params.outputs.PKG }}"

          {
            echo "## Build Celeste Android"
            echo ""
            echo "| Item | Valor |"
            echo "|---|---|"
            echo "| Data (UTC) | $(date -u) |"
            echo "| OS | ${OS_NAME} |"
            echo "| Kernel | ${KERNEL} |"
            echo "| Java | ${JAVA_LINE} |"
            echo "| .NET SDK | ${DOTNET_V} |"
            echo "| Mono | ${MONO_V} |"
            echo "| Android APIs instaladas | ${ANDROID_API} + ${ANDROID_API_EXTRA} |"
            echo "| Build-Tools | ${BUILD_TOOLS} |"
            echo "| NDK | ${NDK_VERSION} |"
            echo "| CMake | ${CMAKE_VERSION} |"
            echo "| ANDROID_SDK_ROOT | ${ANDROID_SDK_ROOT:-unset} |"
            echo "| Projeto | ${PROJECT_FILE} |"
            echo "| Config | ${CONFIG} |"
            echo "| Verbose | ${VFLAG} |"
            echo "| RID | ${RID} |"
            echo "| PackageFormat override | ${PKG:-<usa csproj>} |"
            echo "| APKs | ${APK_COUNT} |"
            echo "| AABs | ${AAB_COUNT} |"
            echo ""
            echo "### SHA256"
            echo "\`\`\`"
            cat artifacts/SHA256SUMS.txt 2>/dev/null || true
            echo "\`\`\`"
            echo ""
            echo "### Artefatos"
            echo "- build-output (apk/aab + SHA256SUMS.txt)"
            echo "- build-logs (logs completos)"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: artifacts/
          if-no-files-found: error

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/
          if-no-files-found: warn
