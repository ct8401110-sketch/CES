name: Android Build â€” MGCB first

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

env:
  CONTENT_ZIP_URL: https://github.com/ASZssz/CES/releases/download/V1/Content.zip
  ANDROID_API_LEVEL: '35'
  ANDROID_BUILD_TOOLS: '33.0.2'
  ANDROID_NDK_VERSION: '25.2.9519653'
  DOTNET_SDK: '10.0.x'

jobs:
  setup-and-build:
    name: Setup SDKs, run MGCB and build APK
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java (for Android toolchain)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup dotnet SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_SDK }}

      - name: Show environment info
        shell: bash
        run: |
          echo "---- ENV ----"
          echo "DOTNET: $(dotnet --version || echo 'not found')"
          echo "JAVA: $(java -version 2>&1 | head -n1)"
          uname -a

      - name: Install Android command-line tools
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/android-sdk/cmdline-tools"
          cd "$HOME/android-sdk"

          if [ ! -f "$HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager" ]; then
            curl -fsSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline-tools.zip
            unzip -q cmdline-tools.zip -d cmdline-tools
            mkdir -p cmdline-tools/latest
            mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/ || true
          fi

          export ANDROID_SDK_ROOT="$HOME/android-sdk"
          yes | "$HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$HOME/android-sdk" --licenses || true

          "$HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$HOME/android-sdk" \
            "platform-tools" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "build-tools;${ANDROID_BUILD_TOOLS}" \
            "cmdline-tools;latest" \
            "ndk;${ANDROID_NDK_VERSION}"

      - name: Set Android env
        shell: bash
        run: |
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$HOME/android-sdk" >> "$GITHUB_ENV"
          echo "PATH=$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools:$PATH" >> "$GITHUB_ENV"

      - name: Cache dotnet tools and nuget
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.dotnet/tools
          key: dotnet-cache-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}

      - name: Restore dotnet packages
        shell: bash
        run: |
          dotnet restore src/Celeste.sln

      - name: Install dotnet-mgcb tool (ensured)
        shell: bash
        run: |
          dotnet tool install --global dotnet-mgcb --version 3.8.4.1 || dotnet tool update --global dotnet-mgcb
          echo "PATH=$PATH:$HOME/.dotnet/tools" >> "$GITHUB_ENV"

      - name: Download Content.zip (large)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/_content_dl"
          echo "Downloading from $CONTENT_ZIP_URL"
          curl -fsSL -o "$GITHUB_WORKSPACE/_content_dl/Content.zip" "$CONTENT_ZIP_URL"
          unzip -q "$GITHUB_WORKSPACE/_content_dl/Content.zip" -d "$GITHUB_WORKSPACE/_content_dl/Content"
          ls -la "$GITHUB_WORKSPACE/_content_dl/Content" | sed -n '1,50p'

      - name: Copy Content to Android project (MGCB expects files)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p src/Celeste.Android/Content
          rsync -a --delete "$GITHUB_WORKSPACE/_content_dl/Content/" "src/Celeste.Android/Content/"
          echo "Content size:" && du -sh src/Celeste.Android/Content || true

      - name: Attempt MGCB build (MonoGame Content Builder)
        id: mgcb
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          MGCB_LOG="$GITHUB_WORKSPACE/_mgcb_build.log"
          echo "Starting dotnet-mgcb at $(date)" > "$MGCB_LOG"

          ATTEMPTS=3
          for i in $(seq 1 "$ATTEMPTS"); do
            echo "Attempt $i of $ATTEMPTS" | tee -a "$MGCB_LOG"
            dotnet-mgcb /@:src/Celeste.Android/Content/Content.mgcb /build /platform:Android /outputDir:src/Celeste.Android/Content/obj 2>&1 | tee -a "$MGCB_LOG" \
              && break \
              || echo "mgcb failed attempt $i" | tee -a "$MGCB_LOG"
            sleep 3
          done

          MGCB_EXIT=${PIPESTATUS[0]:-0} || true
          echo "MGCB_EXIT=$MGCB_EXIT" >> "$MGCB_LOG"

          mkdir -p "$GITHUB_WORKSPACE/_mgcb_logs"
          cp "$MGCB_LOG" "$GITHUB_WORKSPACE/_mgcb_logs/mgcb_build.log" || true

      - name: Diagnose MGCB output and collect artifacts
        shell: bash
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/_mgcb_logs"
          echo "Listing content dirs" > "$GITHUB_WORKSPACE/_mgcb_logs/diagnose.txt"
          ls -la src/Celeste.Android/Content >> "$GITHUB_WORKSPACE/_mgcb_logs/diagnose.txt" || true
          ls -la src/Celeste.Android/Content/obj >> "$GITHUB_WORKSPACE/_mgcb_logs/diagnose.txt" || true
          (du -sh src/Celeste.Android/Content || true) >> "$GITHUB_WORKSPACE/_mgcb_logs/diagnose.txt"
          find src/Celeste.Android/Content -type f | head -n 200 > "$GITHUB_WORKSPACE/_mgcb_logs/sample_files.txt" || true

      - name: Build Android APK (dotnet publish)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts/Release"
          echo "Publishing APK (Release)" > "$GITHUB_WORKSPACE/_publish_log.txt"
          dotnet publish src/Celeste.Android -c Release -p:AndroidSdkDirectory="$HOME/android-sdk" -o "$GITHUB_WORKSPACE/artifacts/Release" --nologo 2>&1 | tee -a "$GITHUB_WORKSPACE/_publish_log.txt"
          echo "publish exit=$?" >> "$GITHUB_WORKSPACE/_publish_log.txt" || true

      - name: Find generated artifacts and list APKs
        shell: bash
        run: |
          echo "Artifacts:" >> "$GITHUB_WORKSPACE/_publish_log.txt"
          find "$GITHUB_WORKSPACE/artifacts" -maxdepth 4 -type f -print | tee -a "$GITHUB_WORKSPACE/_publish_log.txt" || true
          find src/Celeste.Android/bin -type f -iname "*.apk" -print || true

      - name: "Upload artifacts: APK, logs, MGCB outputs"
        uses: actions/upload-artifact@v4
        with:
          name: celeste-android-complete
          path: |
            $GITHUB_WORKSPACE/artifacts
            src/Celeste.Android/bin/Release
            $GITHUB_WORKSPACE/_mgcb_logs
            $GITHUB_WORKSPACE/_publish_log.txt

      - name: Cleanup cached content (optional)
        if: always()
        shell: bash
        run: |
          rm -rf "$GITHUB_WORKSPACE/_content_dl" || true
