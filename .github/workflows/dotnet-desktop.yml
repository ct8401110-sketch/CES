name: Build Celeste Android (MonoGame + .NET) — Final Verbose + Binlog

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: "Release ou Debug"
        required: false
        default: "Release"
      verbose:
        description: "true = diag | false = normal"
        required: false
        default: "false"
      rid:
        description: "RuntimeIdentifiers (ex: android-arm64)"
        required: false
        default: "android-arm64"
      package_format:
        description: "apk ou aab (se vazio usa csproj)"
        required: false
        default: ""
      content_zip_url:
        description: "URL do Content.zip (se vazio, nao baixa)"
        required: false
        default: "https://github.com/ASZssz/CES/releases/download/V1/Content.zip"

concurrency:
  group: celeste-android-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: "9.0.x"

  ANDROID_API: "34"
  ANDROID_API_EXTRA: "35"
  BUILD_TOOLS: "34.0.0"
  NDK_VERSION: "26.3.11579264"
  CMAKE_VERSION: "3.22.1"

  ANDROID_SDK_DIR: ${{ github.workspace }}/.android-sdk
  CMDLINE_TOOLS_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  NUGET_XMLDOC_MODE: skip
  DEBIAN_FRONTEND: noninteractive
  MSBUILDDISABLENODEREUSE: "1"

  PROJECT_FILE: src/Celeste.Android/Celeste.Android.csproj
  CONFIGURATION_DEFAULT: Release
  CONTENT_DEST_DIR: src/Celeste.Android/Content

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/logs" "${GITHUB_WORKSPACE}/artifacts" "${GITHUB_WORKSPACE}/publish"
          mkdir -p "${ANDROID_SDK_DIR}"
          mkdir -p "${HOME}/.android"
          touch "${HOME}/.android/repositories.cfg"
          echo "Workspace: ${GITHUB_WORKSPACE}"
          echo "Project:   ${PROJECT_FILE}"

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_DIR }}
          key: android-sdk-${{ runner.os }}-api${{ env.ANDROID_API }}-api${{ env.ANDROID_API_EXTRA }}-bt${{ env.BUILD_TOOLS }}-ndk${{ env.NDK_VERSION }}-cmake${{ env.CMAKE_VERSION }}-v10

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj','**/*.sln','**/global.json','NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: System packages + Mono
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/apt.log"
          exec > >(tee -a "$LOG") 2>&1

          sudo apt-get update -y -qq
          sudo apt-get install -y -qq --no-install-recommends \
            git curl wget unzip zip tar xz-utils ca-certificates gnupg \
            build-essential cmake ninja-build pkg-config \
            clang llvm lld \
            python3 python3-pip \
            libsdl2-dev libopenal-dev libfreetype6-dev libfontconfig1-dev \
            libssl-dev zlib1g-dev \
            mono-complete

          mono --version | head -n 2 || true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET Android workload
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/dotnet-workload.log"
          exec > >(tee -a "$LOG") 2>&1

          dotnet --info
          dotnet workload list || true
          if ! dotnet workload list | grep -qi "android"; then
            dotnet workload install android
          fi
          dotnet workload list | sed -n '1,260p' || true

      - name: Android SDK (cmdline-tools + packages)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/android-sdk.log"
          exec > >(tee -a "$LOG") 2>&1

          SDK="${ANDROID_SDK_DIR}"
          mkdir -p "${SDK}/cmdline-tools" "${SDK}/platform-tools"

          if [ ! -d "${SDK}/cmdline-tools/latest" ]; then
            TMP_ZIP="/tmp/cmdline-tools.zip"
            TMP_DIR="/tmp/cmdline-extract"

            curl -fsSL "${CMDLINE_TOOLS_URL}" -o "${TMP_ZIP}"
            rm -rf "${TMP_DIR}"
            mkdir -p "${TMP_DIR}"
            unzip -q "${TMP_ZIP}" -d "${TMP_DIR}"

            mkdir -p "${SDK}/cmdline-tools/latest"

            if [ -d "${TMP_DIR}/cmdline-tools" ]; then
              cp -R "${TMP_DIR}/cmdline-tools/"* "${SDK}/cmdline-tools/latest/"
            elif [ -d "${TMP_DIR}/tools" ]; then
              cp -R "${TMP_DIR}/tools/"* "${SDK}/cmdline-tools/latest/"
            else
              cp -R "${TMP_DIR}/"* "${SDK}/cmdline-tools/latest/" || true
            fi

            rm -rf "${TMP_DIR}" "${TMP_ZIP}"
          fi

          export ANDROID_HOME="${SDK}"
          export ANDROID_SDK_ROOT="${SDK}"
          export PATH="${SDK}/cmdline-tools/latest/bin:${SDK}/platform-tools:${PATH}"

          SDKMANAGER="${SDK}/cmdline-tools/latest/bin/sdkmanager"
          [ -x "$SDKMANAGER" ] || chmod +x "$SDKMANAGER" || true
          [ -x "$SDKMANAGER" ] || (ls -la "${SDK}/cmdline-tools/latest/bin" && exit 1)

          "$SDKMANAGER" --version

          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null
          lic_rc="${PIPESTATUS[1]}"
          set -o pipefail
          [ "$lic_rc" -eq 0 ] || (echo "Falha licenças rc=$lic_rc" && exit "$lic_rc")

          set +o pipefail
          yes | "$SDKMANAGER" --install \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "platforms;android-${ANDROID_API_EXTRA}" \
            "build-tools;${BUILD_TOOLS}" \
            "ndk;${NDK_VERSION}" \
            "cmake;${CMAKE_VERSION}" >/dev/null
          inst_rc="${PIPESTATUS[1]}"
          set -o pipefail
          [ "$inst_rc" -eq 0 ] || (echo "Falha install SDK rc=$inst_rc" && exit "$inst_rc")

          echo "${SDK}/cmdline-tools/latest/bin" >> "${GITHUB_PATH}"
          echo "${SDK}/platform-tools" >> "${GITHUB_PATH}"
          echo "ANDROID_HOME=${SDK}" >> "${GITHUB_ENV}"
          echo "ANDROID_SDK_ROOT=${SDK}" >> "${GITHUB_ENV}"

          adb version || true
          ls -la "${SDK}/platforms" || true

      - name: Download Content.zip (se fornecido)
        if: ${{ inputs.content_zip_url != '' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/content.log"
          exec > >(tee -a "$LOG") 2>&1

          echo "CONTENT_ZIP_URL=${{ inputs.content_zip_url }}"
          mkdir -p "${CONTENT_DEST_DIR}"
          rm -rf "${CONTENT_DEST_DIR:?}/"* || true

          curl -fL "${{ inputs.content_zip_url }}" -o /tmp/Content.zip

          echo "Conteúdo do zip (top 80):"
          unzip -l /tmp/Content.zip | head -n 80 || true

          echo "Extraindo..."
          unzip -q /tmp/Content.zip -d "${CONTENT_DEST_DIR}"
          rm -f /tmp/Content.zip

          echo "Tamanho Content:"
          du -sh "${CONTENT_DEST_DIR}" || true

          echo "Top 40 maiores arquivos:"
          (cd "${CONTENT_DEST_DIR}" && find . -type f -printf "%s %p\n" | sort -nr | head -n 40) || true

      - name: Compute build params
        id: params
        shell: bash
        run: |
          set -Eeuo pipefail

          CONFIG="${{ inputs.configuration }}"
          if [ -z "${CONFIG}" ]; then
            CONFIG="${CONFIGURATION_DEFAULT}"
          fi

          VERBOSE="${{ inputs.verbose }}"
          VFLAG="normal"
          if [ "${VERBOSE}" = "true" ]; then
            VFLAG="diag"
          fi

          RID="${{ inputs.rid }}"
          if [ -z "${RID}" ]; then
            RID="android-arm64"
          fi

          PKG="${{ inputs.package_format }}"
          if [ -z "${PKG}" ]; then
            PKG=""
          fi

          echo "CONFIG=${CONFIG}" >> "$GITHUB_OUTPUT"
          echo "VFLAG=${VFLAG}" >> "$GITHUB_OUTPUT"
          echo "RID=${RID}" >> "$GITHUB_OUTPUT"
          echo "PKG=${PKG}" >> "$GITHUB_OUTPUT"

      - name: Restore (com heartbeat + log)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/restore.log"
          exec > >(tee -a "$LOG") 2>&1

          ( while true; do echo "[heartbeat] $(date -u) restore rodando..."; sleep 60; done ) &
          HB_PID=$!
          trap 'kill $HB_PID >/dev/null 2>&1 || true' EXIT

          dotnet restore "${PROJECT_FILE}" \
            -p:AndroidSdkDirectory="${ANDROID_SDK_DIR}" \
            -p:AcceptAndroidSDKLicenses=true \
            -v "${{ steps.params.outputs.VFLAG }}"

          kill $HB_PID >/dev/null 2>&1 || true
          trap - EXIT

      - name: Build (com binlog + console verbose + heartbeat)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/build.log"
          exec > >(tee -a "$LOG") 2>&1

          CONFIG="${{ steps.params.outputs.CONFIG }}"
          VFLAG="${{ steps.params.outputs.VFLAG }}"
          RID="${{ steps.params.outputs.RID }}"
          PKG="${{ steps.params.outputs.PKG }}"

          EXTRA_PROPS=()
          EXTRA_PROPS+=("-p:AndroidSdkDirectory=${ANDROID_SDK_DIR}")
          EXTRA_PROPS+=("-p:AcceptAndroidSDKLicenses=true")
          EXTRA_PROPS+=("-p:RuntimeIdentifiers=${RID}")

          if [ -n "${PKG}" ]; then
            EXTRA_PROPS+=("-p:AndroidPackageFormat=${PKG}")
          fi

          # Logger parameters (mostra mais o que está acontecendo)
          CLP="Summary;Verbosity=${VFLAG};ShowTimestamp"

          # Heartbeat pra não ficar “silencioso”
          ( while true; do echo "[heartbeat] $(date -u) build rodando..."; sleep 60; done ) &
          HB_PID=$!
          trap 'kill $HB_PID >/dev/null 2>&1 || true' EXIT

          echo "CMD: dotnet build ${PROJECT_FILE} -c ${CONFIG} -v ${VFLAG}"
          dotnet build "${PROJECT_FILE}" -c "${CONFIG}" -v "${VFLAG}" \
            -clp:"${CLP}" \
            -bl:"${GITHUB_WORKSPACE}/logs/build.binlog" \
            "${EXTRA_PROPS[@]}"

          kill $HB_PID >/dev/null 2>&1 || true
          trap - EXIT

      - name: Publish (com binlog + console verbose + heartbeat)
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/publish.log"
          exec > >(tee -a "$LOG") 2>&1

          CONFIG="${{ steps.params.outputs.CONFIG }}"
          VFLAG="${{ steps.params.outputs.VFLAG }}"
          RID="${{ steps.params.outputs.RID }}"
          PKG="${{ steps.params.outputs.PKG }}"

          EXTRA_PROPS=()
          EXTRA_PROPS+=("-p:AndroidSdkDirectory=${ANDROID_SDK_DIR}")
          EXTRA_PROPS+=("-p:AcceptAndroidSDKLicenses=true")
          EXTRA_PROPS+=("-p:RuntimeIdentifiers=${RID}")

          if [ -n "${PKG}" ]; then
            EXTRA_PROPS+=("-p:AndroidPackageFormat=${PKG}")
          fi

          rm -rf "${GITHUB_WORKSPACE}/publish"
          mkdir -p "${GITHUB_WORKSPACE}/publish"

          CLP="Summary;Verbosity=${VFLAG};ShowTimestamp"

          ( while true; do echo "[heartbeat] $(date -u) publish rodando..."; sleep 60; done ) &
          HB_PID=$!
          trap 'kill $HB_PID >/dev/null 2>&1 || true' EXIT

          echo "CMD: dotnet publish ${PROJECT_FILE} -c ${CONFIG} -v ${VFLAG}"
          dotnet publish "${PROJECT_FILE}" -c "${CONFIG}" -v "${VFLAG}" \
            -o "${GITHUB_WORKSPACE}/publish" \
            -clp:"${CLP}" \
            -bl:"${GITHUB_WORKSPACE}/logs/publish.binlog" \
            "${EXTRA_PROPS[@]}"

          kill $HB_PID >/dev/null 2>&1 || true
          trap - EXIT

          echo "Listando publish (top 200):"
          find "${GITHUB_WORKSPACE}/publish" -type f | head -n 200 || true

      - name: Collect APK/AAB (agressivo) + hashes
        shell: bash
        run: |
          set -Eeuo pipefail
          LOG="${GITHUB_WORKSPACE}/logs/collect.log"
          exec > >(tee -a "$LOG") 2>&1

          mkdir -p "${GITHUB_WORKSPACE}/artifacts"

          mapfile -t BUNDLES < <(find "${GITHUB_WORKSPACE}" -type f \( -name "*.apk" -o -name "*.aab" \) | sort || true)
          if [ "${#BUNDLES[@]}" -eq 0 ]; then
            echo "Nenhum APK/AAB encontrado."
            echo "Dump publish (top 400):"
            find "${GITHUB_WORKSPACE}/publish" -type f | head -n 400 || true
            echo "Dump bin/obj Android (top 400):"
            find "${GITHUB_WORKSPACE}/src/Celeste.Android" -type f | head -n 400 || true
            exit 1
          fi

          echo "Outputs encontrados:"
          printf '%s\n' "${BUNDLES[@]}"

          for b in "${BUNDLES[@]}"; do
            cp -f "$b" "${GITHUB_WORKSPACE}/artifacts/$(basename "$b")"
          done

          (cd "${GITHUB_WORKSPACE}/artifacts" && sha256sum * > SHA256SUMS.txt)
          ls -la "${GITHUB_WORKSPACE}/artifacts"

      - name: Step Summary
        shell: bash
        run: |
          set -Eeuo pipefail

          OS_NAME="$(grep PRETTY_NAME /etc/os-release | cut -d= -f2- | tr -d '"')"
          KERNEL="$(uname -r)"
          JAVA_LINE="$(java -version 2>&1 | head -n 1 || true)"
          DOTNET_V="$(dotnet --version 2>/dev/null || echo 'n/a')"
          MONO_V="$(mono --version 2>/dev/null | head -n 1 || echo 'n/a')"

          APK_COUNT="$(ls -1 artifacts/*.apk 2>/dev/null | wc -l | tr -d ' ')"
          AAB_COUNT="$(ls -1 artifacts/*.aab 2>/dev/null | wc -l | tr -d ' ')"

          CONFIG="${{ steps.params.outputs.CONFIG }}"
          VFLAG="${{ steps.params.outputs.VFLAG }}"
          RID="${{ steps.params.outputs.RID }}"
          PKG="${{ steps.params.outputs.PKG }}"

          {
            echo "## Build Celeste Android"
            echo ""
            echo "| Item | Valor |"
            echo "|---|---|"
            echo "| Data (UTC) | $(date -u) |"
            echo "| OS | ${OS_NAME} |"
            echo "| Kernel | ${KERNEL} |"
            echo "| Java | ${JAVA_LINE} |"
            echo "| .NET | ${DOTNET_V} |"
            echo "| Mono | ${MONO_V} |"
            echo "| Android APIs | ${ANDROID_API} + ${ANDROID_API_EXTRA} |"
            echo "| BuildTools | ${BUILD_TOOLS} |"
            echo "| NDK | ${NDK_VERSION} |"
            echo "| CMake | ${CMAKE_VERSION} |"
            echo "| Config | ${CONFIG} |"
            echo "| Verbosity | ${VFLAG} |"
            echo "| RID | ${RID} |"
            echo "| PackageFormat override | ${PKG:-<csproj>} |"
            echo "| APKs | ${APK_COUNT} |"
            echo "| AABs | ${AAB_COUNT} |"
            echo ""
            echo "### Logs importantes"
            echo "- logs/build.binlog (MSBuild binlog do build)"
            echo "- logs/publish.binlog (MSBuild binlog do publish)"
            echo "- logs/android-sdk.log (instalação do SDK)"
            echo ""
            echo "### SHA256"
            echo "\`\`\`"
            cat artifacts/SHA256SUMS.txt 2>/dev/null || true
            echo "\`\`\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: artifacts/
          if-no-files-found: error

      - name: Upload logs (inclui binlog)
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/
          if-no-files-found: warn
