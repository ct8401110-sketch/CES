name: Android Build — Dockerized (Android SDK image + .NET + workloads)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  CONTENT_ZIP_URL: https://github.com/ASZssz/CES/releases/download/V1/Content.zip
  CONTENT_ZIP_SHA256: ""

  ANDROID_BASE_IMAGE: cimg/android:2023.10
  DOTNET_CHANNEL: "10.0"

  ARTIFACTS_DIR: artifacts/containerized
  CONTENT_DL_DIR: _content_dl
  CACHE_DIR: _cache

jobs:
  docker-build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          set -euo pipefail
          mkdir -p "${ARTIFACTS_DIR}" "${CONTENT_DL_DIR}" "${CACHE_DIR}/nuget" "${CACHE_DIR}/dotnet" "${CACHE_DIR}/tmp"

      - name: Cache (NuGet + dotnet)
        uses: actions/cache@v4
        with:
          path: |
            _cache/nuget
            _cache/dotnet
          key: ${{ runner.os }}-celeste-android-${{ hashFiles('**/*.csproj', '**/*.sln', '**/Directory.Packages.props', '**/global.json') }}
          restore-keys: |
            ${{ runner.os }}-celeste-android-

      - name: Download Content.zip
        run: |
          set -euo pipefail
          curl -fL --retry 10 --retry-delay 3 --retry-all-errors \
            -o "${CONTENT_DL_DIR}/Content.zip" \
            "${CONTENT_ZIP_URL}"
          ls -lah "${CONTENT_DL_DIR}/Content.zip"

          if [[ -n "${CONTENT_ZIP_SHA256}" ]]; then
            echo "${CONTENT_ZIP_SHA256}  ${CONTENT_DL_DIR}/Content.zip" | sha256sum -c -
          fi

      - name: Extract Content.zip
        run: |
          set -euo pipefail
          rm -rf "${CONTENT_DL_DIR}/Content" || true
          mkdir -p "${CONTENT_DL_DIR}/Content"
          unzip -q "${CONTENT_DL_DIR}/Content.zip" -d "${CONTENT_DL_DIR}/Content"
          du -sh "${CONTENT_DL_DIR}/Content" || true

      - name: Pull base Android image
        run: |
          set -euo pipefail
          docker pull "${ANDROID_BASE_IMAGE}"

      - name: Build builder image (Android + .NET + Android workload)
        run: |
          set -euo pipefail

          cat > Dockerfile.android-dotnet <<'DOCKERFILE'
          ARG BASE_IMAGE
          FROM ${BASE_IMAGE}

          USER root
          RUN apt-get update -y && apt-get install -y --no-install-recommends \
                ca-certificates curl unzip rsync git bash \
              && rm -rf /var/lib/apt/lists/*

          ARG DOTNET_CHANNEL
          ENV DOTNET_ROOT=/opt/dotnet
          ENV PATH="/opt/dotnet:${PATH}"
          ENV DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
          ENV DOTNET_CLI_TELEMETRY_OPTOUT=1
          ENV NUGET_XMLDOC_MODE=skip

          RUN mkdir -p /opt/dotnet /tmp/dotnet_home && \
              curl -fsSL https://dot.net/v1/dotnet-install.sh -o /tmp/dotnet-install.sh && \
              chmod +x /tmp/dotnet-install.sh && \
              /tmp/dotnet-install.sh --channel "${DOTNET_CHANNEL}" --install-dir /opt/dotnet && \
              rm -f /tmp/dotnet-install.sh

          ENV DOTNET_CLI_HOME=/tmp/dotnet_home
          RUN dotnet --info && \
              dotnet workload install android --verbosity minimal

          RUN id -u circleci >/dev/null 2>&1 && chown -R circleci:circleci /opt/dotnet /tmp/dotnet_home || true
          USER circleci
          WORKDIR /workspace
          DOCKERFILE

          docker build \
            --build-arg BASE_IMAGE="${ANDROID_BASE_IMAGE}" \
            --build-arg DOTNET_CHANNEL="${DOTNET_CHANNEL}" \
            -t android-dotnet-builder:local \
            -f Dockerfile.android-dotnet .

      - name: Run build inside container
        run: |
          set -euo pipefail

          mkdir -p "${ARTIFACTS_DIR}" "${CACHE_DIR}/nuget" "${CACHE_DIR}/dotnet" "${CACHE_DIR}/tmp"

          cat > "${ARTIFACTS_DIR}/container_build.sh" <<'IN_CONTAINER'
          set -euo pipefail

          echo "== Tool versions =="
          dotnet --info

          # Detecta ANDROID_SDK_ROOT
          if [[ -d "/opt/android-sdk" ]]; then
            export ANDROID_SDK_ROOT="/opt/android-sdk"
          elif [[ -d "/opt/android/sdk" ]]; then
            export ANDROID_SDK_ROOT="/opt/android/sdk"
          elif [[ -d "/home/circleci/android-sdk" ]]; then
            export ANDROID_SDK_ROOT="/home/circleci/android-sdk"
          elif [[ -d "/android-sdk" ]]; then
            export ANDROID_SDK_ROOT="/android-sdk"
          else
            echo "[FATAL] Android SDK não encontrado no container."
            ls -la /opt || true
            ls -la /home || true
            exit 3
          fi
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}"

          export DOTNET_CLI_HOME="/workspace/_cache/dotnet"
          export NUGET_PACKAGES="/workspace/_cache/nuget"
          export TMPDIR="/workspace/_cache/tmp"
          export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
          export DOTNET_CLI_TELEMETRY_OPTOUT=1

          echo "== Workloads =="
          dotnet workload list || true
          if ! dotnet workload list | grep -qiE 'android'; then
            echo "[WARN] android workload ausente; instalando..."
            dotnet workload install android -v minimal
          fi

          echo "== Sync Content =="
          mkdir -p "src/Celeste.Android/Content"
          rsync -a --info=stats2 "/workspace/_content_dl/Content/" "src/Celeste.Android/Content/"

          echo "== Restore =="
          dotnet restore "/workspace/src/Celeste.sln" \
            -p:AndroidSdkDirectory="${ANDROID_SDK_ROOT}" \
            -v minimal

          echo "== Publish =="
          mkdir -p "/workspace/artifacts/containerized"
          dotnet publish "/workspace/src/Celeste.Android" \
            -c Release \
            -o "/workspace/artifacts/containerized" \
            -p:AndroidSdkDirectory="${ANDROID_SDK_ROOT}" \
            -v minimal \
            2>&1 | tee "/workspace/artifacts/containerized/publish_log.txt"

          echo "== Output =="
          ls -lah "/workspace/artifacts/containerized" || true
          IN_CONTAINER

          chmod +x "${ARTIFACTS_DIR}/container_build.sh"

          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -w /workspace \
            android-dotnet-builder:local \
            /bin/bash -lc "/workspace/${ARTIFACTS_DIR}/container_build.sh"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: celeste-android-docker
          path: |
            artifacts/containerized
          if-no-files-found: warn
          retention-days: 14

      - name: Cleanup (always)
        if: always()
        run: |
          set -euo pipefail
          rm -rf "${CONTENT_DL_DIR}" || true
          rm -f Dockerfile.android-dotnet || true
